<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GigaChat Assistant</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="page">
    <header class="header">
      <div>
        <h1 class="title">–ü–æ–º–æ—â–Ω–∏–∫ –Ω–∞ –≤—Å–µ —Ä—É–∫–∏</h1>
        <p class="subtitle">–í–µ–±-–≤–µ—Ä—Å–∏—è –ø–æ–º–æ—â–Ω–∏–∫–∞ –Ω–∞ –±–∞–∑–µ GigaChat</p>
      </div>
      <nav>
        <a href="{{ url_for('history_list') }}" class="btn tiny">–ò—Å—Ç–æ—Ä–∏—è</a>
      </nav>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-list">
          {% for category, message in messages %}
            <div class="flash flash-{{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <main class="content">
      <section class="chat-panel">
        <div class="chat-card rounded-card">
          {% if history %}
            <div class="chat-log" id="chat-log">
              {% for item in history %}
                {% if item.role == 'assistant' %}
                  <div class="bubble bubble-{{ item.role }}">
                    <div class="bubble-meta">
                      –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä
                    </div>
                    <div class="bubble-text">{{ (item.content or '') | format_markdown | safe }}</div>
                    {% if item.meta %}
                      <div class="bubble-meta-details">
                        {% if item.meta.provider and item.meta.model and item.meta.provider in providers %}
                          <div class="meta-row">
                            <span class="meta-label">{{ providers[item.meta.provider].title }} ‚Ä¢ {{ item.meta.model }}</span>
                          </div>
                        {% endif %}
                        <div class="meta-row">
                          {% if item.meta.elapsed is not none %}
                            <span>‚è± {{ item.meta.elapsed | float | round(2) }} c</span>
                          {% endif %}
                          {% if item.meta.total_tokens is not none %}
                            <span>üî¢ {{ item.meta.total_tokens }} —Ç–æ–∫.</span>
                          {% elif item.meta.prompt_tokens is not none or item.meta.completion_tokens is not none %}
                            {% if item.meta.prompt_tokens is not none %}
                              <span>üì• {{ item.meta.prompt_tokens }} —Ç–æ–∫.</span>
                            {% endif %}
                            {% if item.meta.completion_tokens is not none %}
                              <span>üì§ {{ item.meta.completion_tokens }} —Ç–æ–∫.</span>
                            {% endif %}
                          {% endif %}
                          {% if item.meta.cost is defined and item.meta.cost is not none %}
                            <span class="meta-cost">üí∞ {{ item.meta.cost | round(6) }} ‚ÇΩ</span>
                          {% endif %}
                        </div>
                        {% if item.meta.sources %}
                          <div class="meta-row meta-sources">
                            <span class="meta-label">üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏ ({{ item.meta.sources | length }}){% if item.meta.rag_threshold is defined %}, –ø–æ—Ä–æ–≥: {{ item.meta.rag_threshold | float | round(2) }}{% endif %}:</span>
                            <ul class="sources-list">
                              {% for source in item.meta.sources %}
                                <li>
                                  {% if source.path %}
                                    <span class="source-path">{{ source.path }}</span>
                                  {% endif %}
                                  {% if source.chunk_index is not none %}
                                    <span class="source-index">[#{{ source.chunk_index }}]</span>
                                  {% endif %}
                                  {% if source.headings %}
                                    <span class="source-headings">{{ source.headings }}</span>
                                  {% endif %}
                                  {% if source.similarity is defined %}
                                    <span class="source-similarity">(similarity: {{ source.similarity | float | round(3) }})</span>
                                  {% elif source.score is defined %}
                                    <span class="source-score">(score: {{ source.score | float | round(4) }})</span>
                                  {% endif %}
                                </li>
                              {% endfor %}
                            </ul>
                          </div>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                {% else %}
                  <div class="bubble bubble-{{ item.role }}">
                    <div class="bubble-meta">
                      –í—ã
                    </div>
                    <div class="bubble-text">{{ (item.content or '') | format_markdown | safe }}</div>
                    {% if item.meta %}
                      <div class="bubble-meta-details">
                        {% if item.meta.tokens is not none %}
                          <span>üî¢ {{ item.meta.tokens }} —Ç–æ–∫.</span>
                        {% endif %}
                        {% if item.meta.request_tokens is not none %}
                          <span>üìä {{ item.meta.request_tokens }} —Ç–æ–∫. –≤ –∑–∞–ø—Ä–æ—Å–µ</span>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% else %}
            <div class="chat-empty">
              <p>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ ‚Äî –∑–∞–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É.</p>
            </div>
          {% endif %}
        </div>

        <form method="post" action="{{ url_for('index') }}" class="composer-bar rounded-card" id="composer-form">
          <input type="hidden" name="preset" id="composer-preset" value="{{ state.preset_key }}">
          <input type="hidden" name="provider" id="composer-provider" value="{{ state.provider }}">
          <input type="hidden" name="model" id="composer-model" value="{{ state.model }}">
          <input type="hidden" name="temperature" id="composer-temperature" value="{{ '%.2f'|format(state.temperature) }}">
          <input type="hidden" name="use_local_vectors" id="composer-use-local-vectors" value="{% if state.get('use_local_vectors') %}on{% endif %}">
          <input type="hidden" name="rag_threshold" id="composer-rag-threshold" value="{{ '%.2f'|format(state.get('rag_threshold', 0.7)) }}">

          <div class="composer-input-wrapper">
            <textarea
              name="message"
              class="composer-bar-input"
              id="composer-message"
              rows="1"
              placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
            ></textarea>
            <div class="composer-tokens" id="composer-tokens">
              <span class="tokens-count">0 —Ç–æ–∫.</span>
            </div>
          </div>
          <button type="submit" name="action" value="send" class="composer-send" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
            ‚û§
          </button>
          <button type="submit" name="action" value="reset" class="btn tiny">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </form>
      </section>

      <section class="controls rounded-card">
        <form method="post" action="{{ url_for('index') }}" class="controls-form">
          <div class="field-grid">
            <div class="field">
              <label for="provider">–ü—Ä–æ–≤–∞–π–¥–µ—Ä</label>
              <select id="provider" name="provider" class="input">
                {% for key, provider in providers.items() %}
                  <option value="{{ key }}" {% if key == state.provider %}selected{% endif %}>
                    {{ provider.title }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="field">
              <label for="preset">–ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∞</label>
              <select id="preset" name="preset" class="input">
                {% for key, preset in presets.items() %}
                  <option value="{{ key }}" {% if key == state.preset_key %}selected{% endif %}>
                    {{ preset.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="field">
              <label for="model">–ú–æ–¥–µ–ª—å</label>
              <select id="model" name="model" class="input">
                {% for model_key, model_info in models.items() %}
                  <option value="{{ model_key }}" {% if model_key == state.model %}selected{% endif %}>
                    {{ model_info.label }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="field">
              <label for="temperature">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (0.00 ‚Äì 2.00)</label>
              <input
                id="temperature"
                name="temperature"
                type="number"
                class="input"
                min="0"
                max="2"
                step="0.05"
                value="{{ '%.2f'|format(state.temperature) }}"
              >
            </div>

            <div class="field">
              <label class="checkbox-label">
                <input
                  id="use_local_vectors"
                  name="use_local_vectors"
                  type="checkbox"
                  {% if state.get('use_local_vectors') %}checked{% endif %}
                >
                <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –≤–µ–∫—Ç–æ—Ä–æ–≤ (RAG)</span>
              </label>
            </div>

            <div class="field" id="rag-threshold-field" style="{% if not state.get('use_local_vectors') %}display: none;{% endif %}">
              <label for="rag_threshold">–ü–æ—Ä–æ–≥ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (0.0 - 1.0)</label>
              <input
                id="rag_threshold"
                name="rag_threshold"
                type="number"
                class="input"
                min="0"
                max="1"
                step="0.05"
                value="{{ state.get('rag_threshold', 0.7) | float }}"
                title="–ß–∞–Ω–∫–∏ —Å similarity –Ω–∏–∂–µ —ç—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –±—É–¥—É—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã"
              >
              <small class="field-hint">–ß–∞–Ω–∫–∏ —Å similarity –Ω–∏–∂–µ —ç—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –±—É–¥—É—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã</small>
            </div>
          </div>

          <section class="prompt-preview">
            <div class="preview-header">
              <h2>–¢–µ–∫—É—â–∏–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç</h2>
              <span class="current-model">{{ providers[state.provider].title }} ‚Ä¢ {{ models[state.model].label }}</span>
            </div>
            <div class="prompt-text rounded-card" id="prompt-preview">
              {{ presets[state.preset_key].prompt | e | replace('\n', '<br>') | safe }}
            </div>
          </section>

          <div class="preset-action">
            <button type="button" class="btn tiny" id="open-preset-modal">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫—É</button>
          </div>

        </form>
      </section>
    </main>
  </div>

  <div class="modal-backdrop" id="preset-modal-backdrop">
    <div class="modal-card">
      <div class="modal-header">
        <h3>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫—É</h3>
        <button type="button" class="modal-close" id="close-preset-modal">√ó</button>
      </div>
      <form method="post" action="{{ url_for('index') }}" class="modal-form" id="preset-modal-form">
        <input type="hidden" name="preset" id="modal-preset" value="{{ state.preset_key }}">
        <input type="hidden" name="provider" id="modal-provider" value="{{ state.provider }}">
        <input type="hidden" name="model" id="modal-model" value="{{ state.model }}">
        <input type="hidden" name="temperature" id="modal-temperature" value="{{ '%.2f'|format(state.temperature) }}">
        <input type="hidden" name="use_local_vectors" id="modal-use-local-vectors" value="{% if state.get('use_local_vectors') %}on{% endif %}">
        <input type="hidden" name="rag_threshold" id="modal-rag-threshold" value="{{ '%.2f'|format(state.get('rag_threshold', 0.7)) }}">

        <div class="field">
          <label for="modal_preset_title">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input
            id="modal_preset_title"
            name="preset_title"
            class="input"
            type="text"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä ‚Äî –±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º"
          >
        </div>
        <div class="field">
          <label for="modal_preset_prompt">–¢–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞</label>
          <textarea
            id="modal_preset_prompt"
            name="preset_prompt"
            class="input textarea"
            rows="8"
            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –Ω–æ–≤–æ–π –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–∫–∏"
          >{{ presets[state.preset_key].prompt | trim }}</textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn secondary" id="modal-use-current">–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–º</button>
          <div class="modal-action-buttons">
            <button type="button" class="btn link" id="modal-cancel">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" name="action" value="save_preset" class="btn primary small">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    function scrollToBottom() {
      const chatLog = document.getElementById('chat-log');
      if (chatLog) {
        chatLog.scrollTo({
          top: chatLog.scrollHeight,
          behavior: 'smooth'
        });
      }
    }

    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('load', () => {
      setTimeout(scrollToBottom, 100);
    });

    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø–æ—Å–ª–µ DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', scrollToBottom);
    } else {
      scrollToBottom();
    }

    const presetsData = {{ presets | tojson | safe }};
    const providersData = {{ providers | tojson | safe }};
    const providerSelect = document.getElementById('provider');
    const presetSelect = document.getElementById('preset');
    const modelSelect = document.getElementById('model');
    const temperatureInput = document.getElementById('temperature');

    const composerForm = document.getElementById('composer-form');
    const composerPreset = document.getElementById('composer-preset');
    const composerProvider = document.getElementById('composer-provider');
    const composerModel = document.getElementById('composer-model');
    const composerTemperature = document.getElementById('composer-temperature');
    const composerUseLocalVectors = document.getElementById('composer-use-local-vectors');
    const composerRagThreshold = document.getElementById('composer-rag-threshold');
    const useLocalVectorsCheckbox = document.getElementById('use_local_vectors');
    const ragThresholdField = document.getElementById('rag-threshold-field');
    const ragThresholdInput = document.getElementById('rag_threshold');
    const composerInput = document.getElementById('composer-message');
    const composerTokens = document.getElementById('composer-tokens');
    const tokensCountSpan = composerTokens ? composerTokens.querySelector('.tokens-count') : null;

    const promptPreview = document.getElementById('prompt-preview');
    const currentModelBadge = document.querySelector('.current-model');

    const presetModalBackdrop = document.getElementById('preset-modal-backdrop');
    const presetModalForm = document.getElementById('preset-modal-form');
    const openPresetModalBtn = document.getElementById('open-preset-modal');
    const closePresetModalBtn = document.getElementById('close-preset-modal');
    const modalUseCurrentBtn = document.getElementById('modal-use-current');
    const modalPresetInput = document.getElementById('modal-preset');
    const modalProviderInput = document.getElementById('modal-provider');
    const modalModelInput = document.getElementById('modal-model');
    const modalTemperatureInput = document.getElementById('modal-temperature');
    const modalPresetPromptInput = document.getElementById('modal_preset_prompt');

    function formatPromptHTML(text) {
      return text ? text.replace(/\n/g, '<br>') : '';
    }

    // –ü–æ–¥—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ estimate_tokens –≤ Python: ~1 —Ç–æ–∫–µ–Ω = 4 —Å–∏–º–≤–æ–ª–∞)
    function estimateTokens(text) {
      if (!text || text.trim().length === 0) return 0;
      return Math.max(1, Math.floor(text.length / 4));
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
    function updateTokensCount() {
      if (!composerInput || !tokensCountSpan) return;
      const text = composerInput.value || '';
      const tokens = estimateTokens(text);
      tokensCountSpan.textContent = `${tokens} —Ç–æ–∫.`;
    }

    function updateModelOptions() {
      if (!providerSelect || !modelSelect) return;
      const providerKey = providerSelect.value;
      const provider = providersData[providerKey] || { models: {} };
      const modelsMap = provider.models || {};
      const previousValue = modelSelect.value;
      let firstValue = null;

      modelSelect.innerHTML = '';
      Object.entries(modelsMap).forEach(([value, meta]) => {
        if (firstValue === null) firstValue = value;
        const option = document.createElement('option');
        option.value = value;
        option.textContent = meta.label || value;
        if (value === previousValue) option.selected = true;
        modelSelect.appendChild(option);
      });

      if (!modelsMap[previousValue] && firstValue) {
        modelSelect.value = firstValue;
      }
    }

    function updatePromptPreview() {
      const preset = presetsData[presetSelect.value];
      if (preset && promptPreview) {
        promptPreview.innerHTML = formatPromptHTML(preset.prompt);
      }
    }

    function updateBadges() {
      if (!currentModelBadge) return;
      const provider = providersData[providerSelect.value] || {};
      const modelsMap = provider.models || {};
      const providerTitle = provider.title || providerSelect.value;
      const modelMeta = modelsMap[modelSelect.value] || {};
      const modelTitle = modelMeta.label || modelSelect.value;
      currentModelBadge.textContent = `${providerTitle} ‚Ä¢ ${modelTitle}`;
    }

    function syncHiddenFields() {
      if (composerPreset) composerPreset.value = presetSelect.value;
      if (composerProvider) composerProvider.value = providerSelect.value;
      if (composerModel) composerModel.value = modelSelect.value;
      if (composerTemperature) composerTemperature.value = temperatureInput.value;
      if (composerUseLocalVectors && useLocalVectorsCheckbox) {
        composerUseLocalVectors.value = useLocalVectorsCheckbox.checked ? 'on' : '';
      }
      if (composerRagThreshold && ragThresholdInput) {
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç—Å—è
        const thresholdValue = parseFloat(ragThresholdInput.value) || 0.7;
        composerRagThreshold.value = Math.max(0.0, Math.min(1.0, thresholdValue)).toFixed(2);
      }

      if (modalPresetInput) modalPresetInput.value = presetSelect.value;
      if (modalProviderInput) modalProviderInput.value = providerSelect.value;
      if (modalModelInput) modalModelInput.value = modelSelect.value;
      if (modalTemperatureInput) modalTemperatureInput.value = temperatureInput.value;
      const modalUseLocalVectors = document.getElementById('modal-use-local-vectors');
      if (modalUseLocalVectors && useLocalVectorsCheckbox) {
        modalUseLocalVectors.value = useLocalVectorsCheckbox.checked ? 'on' : '';
      }
      const modalRagThreshold = document.getElementById('modal-rag-threshold');
      if (modalRagThreshold && ragThresholdInput) {
        const thresholdValue = parseFloat(ragThresholdInput.value) || 0.7;
        modalRagThreshold.value = Math.max(0.0, Math.min(1.0, thresholdValue)).toFixed(2);
      }
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –ø–æ—Ä–æ–≥–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —á–µ–∫–±–æ–∫—Å–∞ RAG
    function toggleRagThresholdField() {
      if (ragThresholdField && useLocalVectorsCheckbox) {
        ragThresholdField.style.display = useLocalVectorsCheckbox.checked ? 'block' : 'none';
      }
    }

    function syncAll() {
      updateModelOptions();
      updatePromptPreview();
      updateBadges();
      syncHiddenFields();
    }

    if (providerSelect) providerSelect.addEventListener('change', syncAll);
    if (presetSelect) presetSelect.addEventListener('change', syncAll);
    if (modelSelect) modelSelect.addEventListener('change', syncAll);
    if (temperatureInput) temperatureInput.addEventListener('input', syncAll);
    if (useLocalVectorsCheckbox) {
      useLocalVectorsCheckbox.addEventListener('change', () => {
        toggleRagThresholdField();
        syncAll();
      });
    }
    if (ragThresholdInput) {
      ragThresholdInput.addEventListener('input', () => {
        syncHiddenFields(); // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        syncAll();
      });
      ragThresholdInput.addEventListener('change', () => {
        syncHiddenFields(); // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
      });
    }
    if (composerForm) {
      composerForm.addEventListener('submit', (e) => {
        syncHiddenFields(); // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
      });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª—è –ø–æ—Ä–æ–≥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    toggleRagThresholdField();

    function openPresetModal() {
      if (!presetModalBackdrop) return;
      syncAll();
      if (modalPresetPromptInput) {
        const preset = presetsData[presetSelect.value];
        modalPresetPromptInput.value = preset ? preset.prompt : '';
        modalPresetPromptInput.dataset.dirty = '0';
      }
      presetModalBackdrop.classList.add('is-open');
    }

    function closePresetModal() {
      if (presetModalBackdrop) {
        presetModalBackdrop.classList.remove('is-open');
      }
    }

    if (openPresetModalBtn) openPresetModalBtn.addEventListener('click', openPresetModal);
    if (closePresetModalBtn) closePresetModalBtn.addEventListener('click', closePresetModal);
    if (presetModalBackdrop) {
      presetModalBackdrop.addEventListener('click', (event) => {
        if (event.target === presetModalBackdrop) closePresetModal();
      });
    }

    if (modalUseCurrentBtn && modalPresetPromptInput) {
      modalUseCurrentBtn.addEventListener('click', (event) => {
        event.preventDefault();
        const preset = presetsData[presetSelect.value];
        if (preset) {
          modalPresetPromptInput.value = preset.prompt;
          modalPresetPromptInput.dataset.dirty = '0';
        }
      });
    }

    if (modalPresetPromptInput) {
      modalPresetPromptInput.addEventListener('input', () => {
        modalPresetPromptInput.dataset.dirty = '1';
      });
    }

    if (presetModalForm) presetModalForm.addEventListener('submit', syncHiddenFields);

    syncAll();

    function autoResizeTextarea() {
      if (!composerInput) return;
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ scrollHeight
      composerInput.style.height = 'auto';
      
      // –ü–æ–ª—É—á–∞–µ–º –≤—ã—Å–æ—Ç—É –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
      const computedStyle = window.getComputedStyle(composerInput);
      const fontSize = parseFloat(computedStyle.fontSize) || 15;
      const lineHeightValue = computedStyle.lineHeight;
      
      // –ï—Å–ª–∏ line-height –∑–∞–¥–∞–Ω –≤ em (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.5), –≤—ã—á–∏—Å–ª—è–µ–º –≤ –ø–∏–∫—Å–µ–ª—è—Ö
      let lineHeight;
      if (lineHeightValue.includes('em')) {
        const emValue = parseFloat(lineHeightValue);
        lineHeight = fontSize * emValue;
      } else {
        lineHeight = parseFloat(lineHeightValue) || fontSize * 1.5;
      }
      
      // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è 12 —Å—Ç—Ä–æ–∫
      const maxLines = 12;
      const maxHeight = lineHeight * maxLines;
      
      // –¢–µ–∫—É—â–∞—è –≤—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (scrollHeight –≤–∫–ª—é—á–∞–µ—Ç padding)
      const scrollHeight = composerInput.scrollHeight;
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É
      if (scrollHeight <= maxHeight) {
        // –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ–º–µ—â–∞–µ—Ç—Å—è –≤ 12 —Å—Ç—Ä–æ–∫ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        composerInput.style.height = scrollHeight + 'px';
        composerInput.style.overflowY = 'hidden';
      } else {
        // –ö–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–µ–≤—ã—à–∞–µ—Ç 12 —Å—Ç—Ä–æ–∫ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É
        composerInput.style.height = maxHeight + 'px';
        composerInput.style.overflowY = 'auto';
      }
    }

    if (composerInput) {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      updateTokensCount();
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
      composerInput.addEventListener('input', () => {
        autoResizeTextarea();
        updateTokensCount();
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          autoResizeTextarea();
          updateTokensCount();
        });
      } else {
        // DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
        setTimeout(() => {
          autoResizeTextarea();
          updateTokensCount();
        }, 0);
      }
      
      // –¢–∞–∫–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ load –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ DOM –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ø–æ–∑–∂–µ
      window.addEventListener('load', () => {
        autoResizeTextarea();
        updateTokensCount();
      });
    }
  </script>
</body>
</html>

